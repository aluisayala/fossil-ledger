#!/usr/bin/env python3
import json, hashlib, sys, pathlib

def canonical_bytes(obj):
    return json.dumps(obj, sort_keys=True, separators=(",", ":")).encode("utf-8")

def compute_fossil_hash(obj):
    obj = dict(obj)  # shallow copy
    obj.pop("fossil_hash", None)
    return hashlib.sha256(canonical_bytes(obj)).hexdigest()

def main(path):
    p = pathlib.Path(path)
    data = json.loads(p.read_text(encoding="utf-8"))
    want = data.get("fossil_hash", "").lower()
    got  = compute_fossil_hash(data)
    ok = (want == got) and (data.get("hash_algorithm") == "sha256")
    print(f"file: {p}\nexpected: {want}\ncomputed: {got}\nstatus: {'OK' if ok else 'MISMATCH'}")
    return 0 if ok else 1

if __name__ == "__main__":
    sys.exit(main(sys.argv[1]))
